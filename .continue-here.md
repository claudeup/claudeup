---
pr: 218
branch: feat/breadcrumb-status-list
task: PR review fix (items 1-3)
status: in_progress
last_updated: 2026-02-28T15:20:00Z
---

## Current State

Fixing 3 items from PR #218 review. Fix #3 (nested profile name) is GREEN. Fix #1 (cross-scope false positive) has tests written but they're still failing due to a test fixture issue. Fix #2 (CLAUDE.md update) is pending.

## PR #218 Context

PR title: `feat: show last-applied profile and modified marker in status/list`
Branch: `feat/breadcrumb-status-list`
Two reviewers commented: "claude" (general review) and "copilot" (inline comments).
Many comments were already addressed by commit 58b76bc. Three remaining items need fixing.

## Completed Work

### Fix #3: Nested profile breadcrumb name mismatch -- GREEN (passing)

- **Bug**: breadcrumb records CLI arg (e.g., "backend") but `DisplayName()` returns path ("team/backend"), so applied marker doesn't appear for nested profiles applied by leaf name
- **Code fix** in `applyProfileWithScope` (`profile_cmd.go:879-884`): after resolving path, normalize `name` to display name format using `filepath.Rel` + `strings.TrimSuffix`
- **Test**: "shows marker on nested profile applied by leaf name" -- runs `profile apply backend` then checks `profile list` output
- Test passes

### Fix #1: Cross-scope false positive -- code written, tests FAILING

- **Bug**: `loadAppliedProfiles` diffs ALL scopes, so user-scope-only profiles appear "(modified)" when there's project/local config
- **Code fix** in `loadAppliedProfiles` (`profile_cmd.go:2239-2259`): after computing diff, filter `diff.Scopes` to only include scopes where `savedPerScope.PerScope.{User,Project,Local}` is non-nil
- **Tests written**: two "does not show (modified) when unrelated config exists at other scopes" tests (status + list)
- **Tests still fail** -- the fixture issue: `readPluginsForScope` reads enabled plugins from `settings.json` via `LoadSettingsForScope`, NOT from `installed_plugins.json`. I fixed the test to use `CreateSettings` + `CreateProjectScopeSettings`, but it still shows modified.
- **Root cause investigation needed**: need to check `LoadSettingsForScope` to understand what it reads for user scope, and verify the test fixtures match. The issue might be that `SnapshotAllScopes` captures something extra at user scope that the saved profile doesn't have, causing a diff even after the scope filter.
- **Debug approach**: try a simpler test -- profile with empty `PerScope.User: &ScopeSettings{}` (no plugins), breadcrumb it, add project-scope settings via `RunInDir(env.TempDir, ...)`, assert not modified. Or add debug logging to see what the actual diff contains.

### Fix #2: CLAUDE.md philosophy update -- NOT STARTED

- CLAUDE.md says `(modified)` markers are "intentionally excluded" but this PR adds them
- Simple text edit to remove that line or update the excluded list

## Key Files

- `internal/commands/profile_cmd.go` -- `loadAppliedProfiles()` at ~L2196, `applyProfileWithScope()` at ~L872
- `test/acceptance/profile_breadcrumb_test.go` -- new tests at end of file
- `internal/profile/snapshot.go` -- `SnapshotAllScopes()`, `readPluginsForScope()`
- `internal/claude/` -- `LoadSettingsForScope()` (need to read this to debug fix #1)

## Key Functions to Understand

- `readPluginsForScope(claudeDir, projectDir, scope)` reads from `settings.json` via `LoadSettingsForScope`, returns enabled plugin names
- `SnapshotAllScopes` captures user/project/local scope settings + marketplaces + extensions
- `ComputeProfileDiff` compares saved vs live profiles across all 3 scopes
- `AsPerScope()` normalizes flat profiles to PerScope format

## Decisions Made

- Scope-restricted diff: filter diff.Scopes post-computation rather than modifying ComputeProfileDiff (keeps profile package API unchanged)
- Breadcrumb name normalization: fix at recording time in applyProfileWithScope rather than at lookup time (fix the source, not the consumer)

## Remaining Work

1. **Debug fix #1 test failure**: find why `LoadSettingsForScope("user", claudeDir, projectDir)` returns different plugins than expected. Check the function signature and what file it reads. The test creates `CreateSettings(map[string]bool{"my-plugin@marketplace": true})` which writes to `env.ClaudeDir/settings.json`, and the binary uses `CLAUDE_CONFIG_DIR=env.ClaudeDir`. They should match.
2. **Fix #2**: Update CLAUDE.md to remove `(modified)` markers from "intentionally excluded" list
3. **Run full breadcrumb test suite** to check for regressions
4. **Run full test suite** (unit + acceptance)
5. **Commit and push**
6. **Reply to PR comment threads** via `gh api`

## Copilot Review Comment IDs (for replies)

- 2867534570: cross-scope diff (checkBreadcrumbModified) -- old code, but underlying issue valid
- 2867534577: nested profile name mismatch
- 2867534580: redundant file I/O -- already fixed
- 2867534583: dead code \_ = appliedScope -- already fixed
- 2867534592: missing nested profile test -- already fixed
- 2867534595: scope-restricted diff (isProfileApplied) -- same as 2867534570

## Next Action

Start by reading `internal/claude/settings.go` to find `LoadSettingsForScope` and understand what file path it reads for "user" scope. Compare that path to what `CreateSettings` writes. This should reveal the test fixture mismatch causing fix #1 tests to fail.
